{% extends 'base.html' %}
{% load static %}

{% block title %}Dependent Dropdowns Example{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'patterns:index' %}">Examples</a></li>
                <li class="breadcrumb-item active">Dependent Dropdowns</li>
            </ol>
        </nav>

        <h2><i class="bi bi-arrow-left-right text-primary"></i> Dependent Dropdowns</h2>
        <p class="lead">Variable selected in dropdown A cannot appear in dropdown B</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Regression Variable Selection</h5>
            </div>
            <div class="card-body">
                <!-- Alpine component -->
                <div x-data="dependentDropdowns()" x-init="init()">
                    <!-- Dataset selector -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Dataset:</label>
                        <select class="form-select" x-model="dataset" @change="handleDatasetChange()">
                            <option value="">Select a dataset</option>
                            {% for ds in datasets %}
                            <option value="{{ ds }}">{{ ds }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- X Variable (only show if dataset selected) -->
                    <div x-show="dataset" x-transition class="mb-3">
                        <label class="form-label fw-bold">X Variable (Independent):</label>
                        <select class="form-select" x-model="xVariable" @change="saveState()">
                            <option value="">Select X variable</option>
                            <template x-for="col in availableForX" :key="col">
                                <option :value="col" x-text="col"></option>
                            </template>
                        </select>
                        <div class="form-text">
                            <span x-show="!xVariable">Choose your independent variable</span>
                            <span x-show="xVariable" class="text-success">
                                <i class="bi bi-check-circle"></i> Selected: <strong x-text="xVariable"></strong>
                            </span>
                        </div>
                    </div>

                    <!-- Y Variable (only show if dataset selected) -->
                    <div x-show="dataset" x-transition class="mb-3">
                        <label class="form-label fw-bold">Y Variable (Dependent):</label>
                        <select class="form-select" x-model="yVariable" @change="saveState()">
                            <option value="">Select Y variable</option>
                            <template x-for="col in availableForY" :key="col">
                                <option :value="col" x-text="col"></option>
                            </template>
                        </select>
                        <div class="form-text">
                            <span x-show="!yVariable">Choose your dependent variable</span>
                            <span x-show="yVariable" class="text-success">
                                <i class="bi bi-check-circle"></i> Selected: <strong x-text="yVariable"></strong>
                            </span>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div x-show="xVariable && yVariable" x-transition class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Analysis Summary:</h6>
                        <p class="mb-0">
                            Predict <strong><span x-text="yVariable"></span></strong>
                            from <strong><span x-text="xVariable"></span></strong>
                            using the <strong><span x-text="dataset"></span></strong> dataset
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" @click="simulateAnalysis()"
                                :disabled="!xVariable || !yVariable">
                            <i class="bi bi-play-fill"></i> Run Analysis
                        </button>
                        <button class="btn btn-outline-secondary" @click="clearState()">
                            <i class="bi bi-x-circle"></i> Clear All
                        </button>
                    </div>

                    <!-- Debug info (helpful for development) -->
                    <div class="mt-3">
                        <details>
                            <summary class="text-muted small" style="cursor: pointer;">
                                <i class="bi bi-bug"></i> Debug State (click to expand)
                            </summary>
                            <pre class="bg-light p-2 mt-2 small"><code x-text="JSON.stringify({
                                dataset,
                                columns: allColumns,
                                xVariable,
                                yVariable,
                                availableForX,
                                availableForY
                            }, null, 2)"></code></pre>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-list-check"></i> Test Checklist</h6>
            </div>
            <div class="card-body">
                <h6 class="small text-muted">Try these scenarios:</h6>
                <ul class="small">
                    <li>Select X variable → verify Y dropdown excludes it</li>
                    <li>Select Y variable → verify X dropdown excludes it</li>
                    <li>Select both → verify summary appears</li>
                    <li>Refresh page (F5) → verify selections restore</li>
                    <li>Clear all → verify both dropdowns show all options</li>
                    <li>Switch datasets → verify variables clear</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-code-slash"></i> Implementation</h6>
            </div>
            <div class="card-body small">
                <h6>Key Techniques:</h6>
                <ul class="mb-0">
                    <li><strong>Computed properties:</strong> <code>availableForX</code> and <code>availableForY</code> filter based on selections</li>
                    <li><strong>localStorage:</strong> Persists state across page loads</li>
                    <li><strong>$nextTick():</strong> Ensures DOM updates before restoring values</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dependent-dropdowns.js' %}"></script>
{% endblock %}
